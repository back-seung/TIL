

## 멀티 스레드

* ### 프로세스 : 

  * 운영체제에서 실행 중인 하나의 애플리케이션
  * 애플리케이션을 실행하면 운영체제로부터 실행에 필요한 메모리를 할당받아 애플리케이션의 코드를 실행하는 것
  * 같은 프로그램을 2개 실행했다면 2개의 프로세스가 생성된 것.

  

* ### 멀티 태스킹 :

  > 두 가지 이상의 작업을 동시에 처리하는 것,
  >
  > 운영체제는 멀티 태스킹을 할 수 있도록 CPU와 메모리 자원을 프로세스마다 적절하게 할당해주고 병렬로 실행시킨다.

  

* ### 멀티 스레드

  > 하나의 프로세스가 두 개의 작업을 처리할 때,
  >
  > 동영상 플레이어는 **동영상 재생**과 **음악 재생**의 역할을한다. 멀티 스레드는 애플리케이션 내부에서의 멀티 태스킹이라고 볼 수 있다.



* ### 멀티 프로세스와 멀티 스레드

  ![image-20220131155518984](C:\Users\seung\AppData\Roaming\Typora\typora-user-images\image-20220131155518984.png

> 멀티 프로세스들은 운영체제에서 할당받은 자신의 메모리를 가지고 실행하기 때문에 서로 독립적이다. 따라서 하나의 프로세스에서 오류가 발생해도 다른 프로세스에게 영향을 미치지 않는다.
> 하지만 멀티 스레드는 **하나의 프로세스 내부에 생성되기 때문에** 하나의 스레드가 예외를 발생시키면 나머지 프로세스 자체가 종료될 수 있어 다른 스레드도 영향을 미치게 된다.
>
> **그렇기 때문에 멀티 스레드에서는 예외 처리에 만전을 기해야 한다.**



### 멀티 스레드 사용의 예

1. 대용량 데이터의 처리 시간을 줄이기 위해 데이터를 분할해서 병렬로 처리
2. UI를 가지고 있는 애플리케이션에서 네트워크 통신을 위해 사용
3. 다수 클라이언트의 요청을 처리하는 서버를 개발할 때



### 메인 스레드

> 모든 자바 애플리케이션은 메인 스레드가 `main()` 메서드를 실행하면서 시작된다.
>
> 첫 코드부터 순차적으로 아래로 실행되며 return문을 만나거나, 마지막 코드를 실행하면 종료된다.



* 메인 스레드는 필요에 따라 작업 스레드를 만들어서 병렬로 코드를 실행할 수 있다. (**멀티 스레드를 생성해서 멀티 태스킹을 수행한다.** ) 

* 싱글 스레드 애플리케이션에서는 메인 스레드가 종료하면 프로세스도 종료된다. 하지만 멀티 스레드 애플리케이션에서는 실행 중인 스레드가 하나라도 있다면 프로세스는 종료되지 않는다. ( 메인 스레드가 먼저 종료되더라도 작업 스레드가 실행중이라면 프로세스는 종료되지 않는다. )



### 작업 스레드 생성과 실행

* Runnable 을 매개값으로 갖는 생성자를 호출해야 한다.

  ```java
  Thread thread = new Thread(Runnable target);
  ```

  > * `Runnable`은 작업 스레드가 실행할 수 있는 코드를 가지고 있는 객체라고 해서 붙여진 이름이다. **인터페이스 타입이기 때문에 구현 객체를 만들어 대입해야한다.** 
  > * `Runnable`에는 `run()` 메서드 하나가 정의되어 있는데 구현 클래스는 `run()`을 재정의해서 작업 스레드가 실행할 코드를 작성해야 한다. 

  

* Runnable 구현 클래스 작성 방법

```java
class Task implements Runnable {
    public void run() {
        스레드가 실행할 코드
    }
}
```



* `Runnable`은 작업 내용을 가지고 있는 객체이지 실제 스레드는 아니다. Runnable 구현 객체를 생성한 후, 이것을 매개값으로 해서 Thread 생성자를 호출하면 비로소 작업 스레드가 생성된다.

```java
Runnable task = new Task();

Thread thread = new Thread(task);
```



* 코드를 좀 더 절약하기 위해 생성자를 호출할 때 Runnable 익명 객체를 매개값으로 사용할 수 있다. 이 방법이 더 많이 사용된다.

```java
Thread thread = new Thread(new Runnable() {
    public void run() {
        스레드가 실행할 코드;
    }
});
```



* `Runnable` 인터페이스는 run() 메소드 하나만 정의되어 있기 때문에 함수적 인터페이스이다. 따라서 다음과 같이 람다식을 매개값으로 사용할 수도 있다.

```java
Thread thread = new Thread( () -> {
    스레드가 실행할 코드;
});
```



* 작업 스레드는 생성 즉시 실행되는 것이 아니라, `start()` 메서드를 다음과 같이 호출해야만 비로소 실행된다.

```java
thread.start();
```

> start() 메서드가 호출되면, 작업 스레드는 매개값으로 받은 Runnable의 run() 메서드를 실행하여 자신의 작업을 처리한다.



### 0.5초 주기로 비프음을 발생시키면서 동시에 프린팅 하는 작업의 예제

### 메인스레드만 사용한 경우

```JAVA
import java.util.*; 

public class BeepPrintExam01 {
    public static void main(String[] args) {
        Toolkit toolkit = new Toolkit.getDefaultToolkit(); // Toolkit 객체 얻기
        for(int i = 0; i < 5; i++) {
            toolkit.beep();
            try {
                Thread.sleep(500);
            } catch(Exception e) {
                e.printStackTrace();
            }
        }
        
        for(int i = 0; i < 5; i++) {
            System.out.println("띵");
            try {
                Thread.sleep(500);
            } catch(Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```

> 메인 스레드는 비프음을 모두 발생한 다음, 프린팅을 시작한다.



### 메인 스레드 + 작업 스레드로 수정



* 비프음 작업 스레드

```java
public class BeepTask implements Runnable {
    public void run() {
        Toolkit toolkit = new Toolkit.getDefaultToolkit();
        for(int i = 0; i < 5; i++) {
            toolkit.beep();
            try {
                Thread.sleep(500);
            } catch(Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```



* 메인 스레드에 작업 스레드 import

```java
public class BeepPrintExam02 {
    public static void main(String[] args) {
        Runnable beepTask = new BeepTask();
        Thread thread = new Thread(beepTask);
        thread.start();
        
        for(int i = 0; i < 5; i++) {
            System.out.println("띵");
            try {
                Thread.sleep(500);
            } catch(Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```





